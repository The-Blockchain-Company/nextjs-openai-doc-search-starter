> ![](vertopal_c8b6decea78745b3acb6d1473b03a391/media/image1.jpeg){width="2.343332239720035in"
> height="0.6333333333333333in"}

A Formal Specification of the Cardano Ledger integrating Plutus Core

Deliverable GL-D2

Andre Knispel <andre.knispel@iohk.io>

Polina Vinogradova <polina.vinogradova@iohk.io>

*Project:* Goguen Ledger

*Type:* Deliverable

*Due Date:* 28^th^ February 2021

> *Responsible team:* Formal Methods Team *Editor:* Andre Knispel, IOHK
> *Team Leader:* Philipp Kant, IOHK
>
> Version FS-2.2.0

## Dissemination Level

> Formal Specification of the Cardano Ledger with Plutus Integration
>
> Polina Vinogradova <polina.vinogradova@iohk.io> Andre Knispel
> <andre.knispel@iohk.io>
>
> **Abstract**
>
> This document presents modifications to the Shelley ledger
> specification [Formal Methods](#_bookmark46) [Team,
> IOHK](#_bookmark46) ([2019c](#_bookmark46)) that will enable it to
> support the requirements for Plutus Foundation, within the context of
> the Goguen era of Cardano. This specification is based on the Plutus
> system and the extended UTxO specification of the mockchain on which
> it operates, as outlined in [Chakravarty et al.](#_bookmark42)
> ([2020](#_bookmark42)). We present a unified way to process both
> Plutus scripts and Shelley-style multi-signature scripts (see [Formal
> Methods Team, IOHK](#_bookmark44) ([2019a](#_bookmark44))).

# List of Contributors

> Duncan Coutts, Philipp Kant, Michal Peyton Jones, Jann Mueller, Jared
> Corduan, Matthias Gudemann, Manuel Chakravarty, Kevin Hammond, Tim
> Sheard, Nicholas Clarke, Alex Byaly, Yun Lu

# Contents

1.  [Introduction](#introduction) 3

    1.  [Phase Two Scripts](#phase-two-scripts) 3

    2.  [Extended UTxO](#extended-utxo) 4

2.  [Language Versions and Cost
    Models](#language-versions-and-cost-models) 5

    1.  [Language Versions and Backwards Compatibility
        Requirements](#language-versions-and-backwards-compatibility-requirements)
        5

    2.  [Determinism of Script
        Evaluation](#determinism-of-script-evaluation) 5

    3.  [Script Evaluation Cost Model and
        Prices](#script-evaluation-cost-model-and-prices) 6

3.  [Transactions](#transactions) 8

    1.  [Witnessing](#witnessing) 9

    2.  [Transactions](#transactions-1) 10

    3.  [Additional Role of Signatures on
        TxBody](#additional-role-of-signatures-on-txbody) 11

    4.  [Data required for script
        validation.](#data-required-for-script-validation.) 12

4.  [UTxO](#utxo) 13

    1.  [Combining Scripts with Their
        Inputs](#combining-scripts-with-their-inputs) 14

    2.  [Plutus Script Validation](#plutus-script-validation) 16

    3.  [Two-Phase Transaction Validation for Phase-2
        Scripts](#two-phase-transaction-validation-for-phase-2-scripts)
        18

    4.  [The UTXOS transition system](#the-utxos-transition-system) 19

    5.  [Witnessing](#witnessing-1) 21

1

5.  [Ledger State Transition](#ledger-state-transition) 25

6.  [Blockchain layer](#blockchain-layer) 27

    1.  [Block Body Transition](#block-body-transition) 27

7.  [MIR Certificates](#mir-certificates) 28

[References](#_bookmark41) 30

[A TxInfo Construction](#txinfo-construction) 31

1.  [Type Translations](#type-translations) 31

2.  [Building Transaction Summary](#building-transaction-summary) 32

```{=html}
<!-- -->
```
B.  [Output Size](#output-size) 37

C.  [Formal Properties](#formal-properties) 38

> **List of Figures**

1.  [Definitions Used in Protocol Parameters](#_bookmark7) 7

2.  [Definitions for Transactions](#_bookmark9) 9

3.  [Definitions for transactions, cont.](#_bookmark11) 10

4.  [Functions related to fees and collateral](#_bookmark16) 13

5.  [Indexing script and data objects](#_bookmark18) 15

6.  [Script Validation, cont.](#_bookmark20) 17

7.  [Scripts and their arguments](#_bookmark22) 19

8.  [UTxO script state update types](#_bookmark24) 20

9.  [State update rules](#_bookmark25) 20

10. [UTxO inference rules](#_bookmark27) 22

11. [UTXOW helper functions](#_bookmark28) 23

12. [UTxO with witnesses state update types](#_bookmark29) 23

13. [UTxO with witnesses inference rules for Tx](#_bookmark30) 24

14. [Ledger inference rules](#_bookmark32) 26

15. [BBody rules](#_bookmark35) 27

16. [Shelley to Alonzo State Transtition](#_bookmark36) 27

17. [Alonzo Types for MIR updates](#_bookmark38) 28

18. [Move Instantaneous Rewards Inference Rule](#_bookmark39) 28

19. [MIR transfer Inference Rule](#_bookmark40) 29

20. [MIR rules](#_bookmark41) 29

21. [TxInfo and Constituent Types](#_bookmark51) 32

22. [TxInfo and Constituent Types](#_bookmark53) 33

23. [Types and Functions Used in Time Conversion](#_bookmark54) 34

24. [TxInfo Constituent Type Translation Functions](#_bookmark55) 35

25. [Script and Data construction correctness checks](#_bookmark56) 35

26. [Transaction Summarization Functions](#_bookmark57) 36

27. [Value Size](#_bookmark59) 37

# Introduction

> This document describes the extensions to the multi-asset formal
> ledger specification [Formal](#_bookmark45) [Methods Team,
> IOHK](#_bookmark45) ([2019b](#_bookmark45)) that are required for the
> support of phase two scripts, in particular Plutus Core. This
> underpins future Plutus development: there should be minimal changes
> to these ledger rules to support future phase-2 languages (eg.
> upcoming versions of Plutus). The two major extensions that are
> described here are:

1.  the introduction of *phase-2* scripts, i.e. scripts that are not
    > evaluated internally by the

> ledger; and 2. additions to the Shelley-era UTxO (unspent transaction
> output) model that are needed to support Plutus constructs (the
> "extended UTxO" model).
>
> This document defines these extensions as changes to the multi-asset
> structured transition system, using the same notation and conventions
> that were used for the multi-asset specifica- tion [Formal Methods
> Team, IOHK](#_bookmark45) ([2019b](#_bookmark45)). As with the
> multi-asset formal specification, these rules will be implemented in
> the form of an executable ledger specification that will then be
> integrated with the Cardano node.

## Phase Two Scripts

> The Shelley formal specification introduced the concept of
> "multi-signature" scripts. *Phase one scripts*, such as these, are
> captured entirely by the ledger rules. Execution costs can therefore
> be easily assessed *before* they are processed by the implementation,
> and any fees can be calculated directly within the ledger rule
> implementation, based on e.g. the size of the transaction that
> includes the script.
>
> In contrast, *phase-2* scripts can perform arbitrary (and, in
> principle, Turing-complete) compu- tations. We require transactions
> that use phase-2 scripts to have a budget in terms of a number of
> abstract ExUnits. This budget gives a quantitative bound on resource
> usage in terms of a number of specific metrics, including memory usage
> or abstract execution steps. The budget is then used as part of the
> transaction fee calculation.
>
> Every phase-2 scripting language converts the calculated execution
> cost into a number of ExUnits using a cost model, CostModel, which
> depends on the language and is provided as a protocol parameter. This
> allows execution costs (and so transaction fees) to be varied without
> requiring a major protocol version change ("hard fork"). This may be
> used, for example, if a more efficient interpreter is produced.
>
> The approach we use to bound execution costs to a pre-determined
> constant is distinct from the usual "gas" model in the following
> notable ways :

-   The budget to run a script is expressed in terms of computational
    resources, and included in the transaction data. The *exact*
    resource budget required can be computed before submitting a
    transaction, since script execution is deterministic. See Section
    [2.2](#determinism-of-script-evaluation). In the gas model, the
    budget is expressed indirectly as an upper bound on the fee the
    submitter is willing to pay for execution of the contract (eg. their
    total available funds).

-   The user specifies the UTxO entries containing funds sufficient to
    cover a percentage (usually 100 or more) of the total transaction
    fee. These inputs are only collected *in the case of script
    validation failure*, and are called *collateral inputs*. In the case
    of script validation success, the fee specified in the fee field of
    the transaction is collected, but the collateral is not.

> This scheme is different from the gas model in that the exact payment
> collected in both the case of script validation success and validation
> failure is known ahead of time, though the collected fees are
> different in the two cases.
>
> Another important point to make about both phase one and two scripts
> on Cardano is that running scripts in all languages will be supported
> indefinitely whenever possible. Making it
>
> impossible to run a script in a particular scripting language makes
> UTxO entries locked by that script unspendable.
>
> We use the terms Plutus, PlutusV1, and "phase two scripting language"
> in this specification somewhat interchangeably. The reason for this is
> that while we intend for the infrastructure set up in this document to
> be somewhat language-agnostic (in particular, able to support multiple
> versions of Plutus), it only gives all the details for the first and
> (currently only) phase-2 script language, PlutusV1, the introduction
> of which represents the start of the Alonzo era.

## Extended UTxO

> The specification of the extended UTxO model follows the description
> that was given in [Chakravarty](#_bookmark42) [et al.](#_bookmark42)
> ([2020](#_bookmark42)). All transaction outputs that are locked by
> phase-2 scripts must include the hash
>
> of an additional "datum". The actual datum needs to be supplied by the
> transaction spending that output, and can be used to encode state, for
> example. While this datum could instead have been stored directly in
> the UTxO, our choice of storing it in the transaction body improves
> space efficiency in the implementation by reducing the UTxO storage
> requirements. The datum is passed to a script that validates that the
> output is spent correctly.
>
> All transactions also need to supply a *redeemer* for all items that
> are validated by a script.
>
> This is an additional piece of data that is passed to the script, and
> that could be considered as a form of user-input to the script. Note
> that the same script could be used for multiple different purposes in
> the same transaction, so in general it might be necessary to include
> more than one redeemer per script. There will, however, always be at
> least one redeemer per script.

# Language Versions and Cost Models

> We require the following types (see Figure [1](#_bookmark7)) in
> addition to those that are already defined in the Shelley
> specification [Formal Methods Team, IOHK](#_bookmark46)
> ([2019c](#_bookmark46)).
>
> ExUnits ExUnits is made up of two integer values, representing
> abstract notions of the relative memory usage and script execution
> steps respectively. We give it the structure of a partially ordered
> monoid via its product structure, i.e. addition and comparisons are
> defined point-wise.
>
> Prices Prices consists of two rational numbers that correspond to the
> components of ExUnits: the price per unit of memory and price per
> reduction step.
>
> CostModel A cost model is a vector of coefficients that are used to
> compute the execution units required to execute a script. Its
> specifics depend on specific versions of the Plutus interpreter it is
> used with. We keep this type as abstract in the specification, see
> [Plutus Team](#_bookmark47) ([2021a](#_bookmark47)) and [Plutus
> Team](#_bookmark48) ([2021b](#_bookmark48)) for details.
>
> Language This represents phase-2 language types. Currently there is
> only PlutusV1.
>
> LangDepView A pair of two byte strings, where the first represents the
> serialized language tag (eg. the tag for PlutusV1), and the second,
> the protocol parameters that must be fixed (by the transaction) when
> carrying a phase-2 script in that language.
>
> The function serialize is left abstract, as these is an
> implementation-dependent serialization function. It must be
> implemented for all serializable types, including all collections of
> protocol parameters needed to construct a LangDepView for each
> existing language.

## Language Versions and Backwards Compatibility Requirements

> In the Language type, each *version* of a language is considered to be
> a different language (so there might be several versions of the Plutus
> language, each of which would be considered to be different). Each
> such language needs to be interpreted by a language-specific
> interpreter that is called from the ledger implementation. The
> interpreter is provided with the (language- and version-specific)
> arguments that it requires. It is necessary for the ledger to be
> capable of executing scripts in all languages it has ever supported.
> This implies that it is necessary to maintain all forms of ledger data
> that is needed by any past or current language, which constrains
> future ledger designs. Introducing a new language will require a
> protocol version update, since the datatypes need to support the new
> language and the ledger rules must be updated to use the new
> interpreter.

## Determinism of Script Evaluation

> The data that is passed to the interpreter includes the validator
> script, the redeemer, possibly a datum from the UTxO, information
> about the transaction that embeds the script, any relevant ledger
> data, and any relevant protocol parameters. It is necessary for the
> validation outcome of any scripts to remain the same during the entire
> period between transaction submission and completion of the script
> processing. In order to achieve this, any data that is passed to the
> interpreter must be determined by the transaction body. In property
> [C.8](#_bookmark62), we make precise what deterministic script
> evaluation means. The transaction body therefore includes a hash of
> any such data that is not uniquely determined by other parts of the
> transaction body or the UTXO. When the transaction is processed, as
> part of the UTXOW rule, this hash is compared with a hash of the data
> that is passed to the interpreter. This ensures that scripts are only
> executed if they have been provided with the intended data.
>
> The getLanguageView function is used in the computation of this
> integrity hash. Shown in (Figure [1](#_bookmark7)), it filters the
> data relvant to a given language from the protocol parameters, and
>
> returns a pair of byte strings : the serialized representation of the
> language tag, and the serialized representation of the relevant data
> in the protocol parameters, which, for PlutusV1, is just its cost
> model, costmdls *pp* PlutusV1 . This function must be defined for all
> existing script languages that require a cost model (are phase-2),
> which, in Alonzo, is only PlutusV1. The only relevant parameter for
> PlutusV1 is the cost model for this language.

## Script Evaluation Cost Model and Prices

> To convert resource primitives into the more abstract ExUnits during
> script execution a cost model needs to be supplied to the interpreter.
> The cost models required for this purpose are recorded in the
> *costmdls* protocol parameter. The calculation of the actual cost, in
> Ada, of running a script that takes *exunits* ExUnits resources to
> run, is done by a formula in the ledger rules, which uses the *prices*
> parameter. This is a parameter that applies to all scripts and that
> cannot be varied for individual languages. This parameter reflects the
> real-world costs in terms of energy usage, hardware resources etc.
>
> In Alonzo, the protocol parameter *minUTxOValue* is deprecated, and
> replaced by *coinsPerUTxOWord*.
>
> This specifies directly the deposit required for storing bytes of data
> on the ledger in the form of UTxO entries.
>
> **Limiting Script Execution Costs.** The *maxTxExUnits* and
> *maxBlockExUnits* protocol parame-
>
> ters are used to limit the total per-transaction and per-block
> resource use. These only apply to phase-2 scripts. The parameters are
> used to ensure that the time and memory that are required to verify a
> block are bounded.
>
> **Value size limit as a protocol parameter.** The new parameter
> *maxValSize* replaces the
>
> constant maxValSize used (in the ShelleyMA era) to limit the size of
> the Value part of an output in a serialised transaction.
>
> **Collateral inputs.** Collateral inputs in a transaction are used to
> cover the transaction fees in the case that a phase-2 script fails
> (see Section [3.2](#transactions-1)). The term *collateral* refers to
> the total Ada contained in the UTxOs referenced by collateral inputs.
>
> The parameter *collateralPercent* is used to specify the percentage of
> the total transaction fee its collateral must (at minimum) cover. The
> collateral inputs must not themselves be locked by a script. That is,
> they must be VKey inputs. The parameter *maxCollateralInputs* is used
> to limit, additionally, the total number of collateral inputs, and
> thus the total number of additional signatures that must be checked
> during validation.
>
> []{#_bookmark7 .anchor}**Figure 1:** Definitions Used in Protocol
> Parameters

# Transactions

> This section outlines the changes that are needed to the transaction
> structure to enable phase-2 scripts to validate the minting of tokens,
> spending outputs, verifying certificates, and verifying withdrawals.
> Figure [2](#_bookmark9) gives the modified transaction types and
> helper functions. We make the following changes and additions:

-   ScriptIntegrityHash is the type of a hash of script execution
    > related data. It is the hash of

> txrdmrs and relevant protocol parameters.

-   Script^ph1^ is the type of phase-1 scripts.

-   Script^ph2^ is the type of phase-2 scripts.

-   Data is a type for communicating data to script. It is kept abstract
    > here.

-   Script is the type of all scripts, both phase-1 and phase-2.

-   IsValid is a tag that indicates that a transaction expects that all
    its phase-2 scripts will be validated. This tag is added by the
    block creator when constructing a block, and its correctness is
    verified as part of the script execution.

-   Datum is a type alias for the Data type, used to signify that terms
    of this type are intended to be used strictly as datum objects.

-   Redeemer is also a type alias for the Data type, used to signify
    that terms of this type are intended to be used strictly as
    redeemers.

-   TxOut is the type of transaction outputs. These are extended to
    > include an optional hash of a datum. Note that *any* output can
    > optionally include such a hash, even though only phase-2 scripts
    > can actually use the hash value. Since it is in general impossible
    > for the ledger implementation to know at the time of transaction
    > creation whether or not an output belongs to a phase-2 script, we
    > simply allow any output to contain a hash of a datum.

-   Tag lets us differentiate what a script can validate, i.e. Spend to
    > validate spending a script UTxO entry; Mint to validate minting
    > tokens;

> Cert to validate certificates with script credentials; and
>
> Rewrd to validate reward withdrawals from script addresses.

-   RdmrPtr is a pair of a tag and an index. This type is used to index
    the Plutus redeemers that are included in a transaction, as
    discussed below.

> We add the following helper functions:

-   language selects the language of a phase-2 script, and *◊* in case
    > the script is phase-1.

-   hashData hashes a value of type Data.

-   hashScriptIntegrity hashes the protocol parameters and data relevant
    > to script execution. In particular, the redeemer structure, and
    > the datum objects.

> **Auxiliary Data.** The auxiliary data in an Alonzo transaction has
> the same structure as in a ShelleyMA transaction, but can additionally
> contain phase-2 scripts.
>
> **Figure 2:** Definitions for Transactions

## Witnessing

> Figure [3](#_bookmark11) defines the witness type, TxWitness. This
> contains everything in a transaction that is needed for witnessing,
> namely:

-   VKey signatures;

-   a map of scripts indexed by their hashes, including phase-2 scripts;

-   a map of terms of type Datum indexed by their hashes, containing all
    required datum objects as well as any supplemental ones that are
    posted for communication (see [4.5](#witnessing-1)); and

-   a map of a pair of a Redeemer object and an ExUnits value indexed by
    RdmrPtr, containing the redeemers and execution units budgets.

> Note that there is a difference between the way scripts and datum
> objects are included in a transaction (as a set) versus how redeemers
> are included (as an indexed structure).
>
> **Figure 3:** Definitions for transactions, cont.
>
> **Hash reference (script/datum object):** Scripts and datum objects
> are referred to explicitly via their hashes, which are included in the
> UTxO or the transaction. Thus, they can be looked up in the
> transaction without any key in the data structure.
>
> **No hash reference (redeemers):** For redeemers, we use a reverse
> pointer approach and index the redeemer by a pointer to the item for
> which it will be used. For details on how a script finds its redeemer,
> see Section [4.1](#combining-scripts-with-their-inputs).

## Transactions

> We have also made the following changes to the body of the
> transaction:

-   The new field collateral is used to specify the *collateral inputs*
    that are collected (into the fee pot) to cover a percentage of
    transaction fees (usually 100 percent or more) *in case the
    transaction contains failing phase-2 scripts*. They are not
    collected otherwise. The purpose of the collateral is to cover the
    resource use costs incurred by block producers running scripts that
    do not validate.

> Collateral inputs behave like regular inputs, except that they must be
> VKey locked and can only contain Ada. See [4](#_bookmark16).
>
> It is permitted to use the same inputs as both collateral and a
> regular inputs, as exactly one set of inputs is ever collected:
> collateral ones in the case of script failure, and regular inputs in
> the case when all scripts validate.

-   There is a new field called reqSignerHashes that is used to specify
    > a set of hashes of keys that must sign the transaction in addition
    > to the signatures required to validate spending from VKey
    > addresses, checking certificate validity, and validating reward
    > withdrawals.

> This field is there to allow users to add signatures that

-   cannot be stripped from a transaction without invalidating it in
    > phase 1 (ie. the validation phase where fees are not collected for
    > the validation work done)

-   are not attached to any validation being done in phase 1, such as
    > VKey output spending

> This is a field where users can add signatures that a phase-2 script
> requires internally - the transaction and the ledger are otherwise
> unaware of what signatures are expected by these scripts.

-   We include a hash of some script-related data, specifically the
    > redeemers and protocol parameters, with accessor
    > scriptIntegrityHash.

-   We include the ID of the network on which the transaction lives,
    txnetworkid. This is in addition to the network ID's already
    included in the reward and output addresses.

> A complete transaction is comprised of:

1.  the transaction body,

2.  all the information that is needed to witness transactions,

3.  the IsValid tag, which indicates whether all scripts that are
    executed during the script execution phase validate. The correctness
    of the tag is verified as part of the ledger rules, and the block is
    deemed to be invalid if it is applied incorrectly. It can be used to
    re-apply blocks without script re-validation. Since this tag is not
    part of the body, i.e. it is not signed, the block producer can (and
    must) choose the correct value.

4.  any auxiliary data.

![](vertopal_c8b6decea78745b3acb6d1473b03a391/media/image2.png){width="0.22091207349081365in"
height="0.23800634295713036in"}

## Additional Role of Signatures on TxBody

> The transaction body and the UTxO must uniquely determine all the data
> that can influence on-chain transfer of value. This is so that the
> signatures can ensure that this data is not tampered with. As before,
> a transaction that does not include the correct signatures is
> completely invalid. Thus, all data that influences script validation
> outcomes must also be determined by the body. Scripts and datum
> objects whose hashes are specified on-chain do not require to be
> signed when included in a transaction. That is, script hashes locking
> UTxOs (as well as with the datum hashes these UTxOs contain), and also
> the posted certificates, minting policies, and reward addresses do not
> need to be signed. The supplemental datum objects (see
> [4.5](#witnessing-1)), however, could be stripped from the transaction
> without making it invalid. The supplemental datums are stored in the
> same map the required ones, so, for this reason, we do include all
> datum objects in the script integrity hash calculation. The hash of
> the indexed redeemer structure and the protocol parameters that are
> used by script interpreters are included in the body of the
> transaction, as
>
> these are composed by the transaction author rather than fixed via a
> hash on the ledger. In the future, other parts of the ledger state may
> also need to be included in this hash, if they are passed as arguments
> to a new script interpreter.

## Data required for script validation.

> The body of the transaction, alongside the witness data, are required
> for script validation. Script validation should not depend on the
> auxiliary data in any way. Script validation may require certain
> supplemental datums (see [4.5](#witnessing-1)) to be posted. For this
> reason, we include supplemental datums in the part of the transaction
> (the witnesses) which scripts do see. Any metadata that a user wants
> to expose to a transaction can be included in the redeemer, whose
> purpose is to contain all user-supplied data relevant to validation.
>
> For more about what scripts do and do not inspect, see Section
> [A](#txinfo-construction).

# UTxO

> []{#_bookmark16 .anchor}**Figure 4:** Functions related to fees and
> collateral
>
> We have added or changed several functions that deal with fees and
> collateral as shown in Figure [4](#_bookmark16).

-   isTwoPhaseScriptAddress is a predicate that checks whether an
    address is used as a script address with a phase-2 script.

-   totExunits calculates the total ExUnits in a transaction by summing
    the per-script units stored in the indexed redeemer structure

-   The predicate feesOK checks whether the transaction is paying the
    necessary fees, and that it does it correctly. That is, it checks
    that:

    i.  the fee amount that the transaction states it is paying suffices
        > to cover the minimum fee that the transaction is obligated to
        > pay; and if the transaction uses phase-2 scripts, that

    ii. the collateral inputs refer only to UTxOs with key-hash
        > addresses;

    iii. all the collateral inputs refer to UTxOs containing Ada only
         > and no other kinds of token; and

    iv. the collateral provided is sufficient to cover the percentage of
        > the transaction fee amount specified by the protocol parameter
        > collateralPercent

    v.  the set of collateral inputs is non-empty

> Note that checking that a transaction is carrying redeemers is the
> most simple way to check that it is carrying phase-2 scripts. A
> separate check is done in the rule prior to calling the feesOK
> function that ensure that this is the case.

-   txscriptfee calculates the fee that a transaction must pay for
    script execution based on the amount of ExUnits it has budgeted, and
    the prices in the current protocol parameters for each component of
    ExUnits. The prices are expressed as rational numbers, so we take
    the ceiling of the result of the calculation to get an
    integer-valued Coin.

-   The minimum fee calculation, minfee, includes the script fees that
    the transaction is obli- gated to pay in order to run its scripts.

> Note that when creating a transaction, the wallet is responsible for
> determining the fees.
>
> Thus, it also has to execute the phase-2 scripts and include the fees
> for their execution.

## Combining Scripts with Their Inputs

> Figure [5](#_bookmark18) shows the functions that are needed to
> retrieve all the data that is relevant to Plutus script validation.
> These include:

-   EI is a global constant needed to compute the current system time.

-   SysSt is another global constant needed to compute the system time.

-   UTCTime is the system time (UTC time zone)

-   ScriptPurpose is a sum type of all parts of a transaction that may
    require a script witness to validate. Note that this contains the
    data (eg. a certificate *c ∈* txcerts *txb*, or a transaction input
    *tin ∈* txcerts *txb*) of the item being validated, not just a tag
    indicating the type.

-   indexof is a helper function that finds the index of a given
    certificate, value, input, or withdrawal in a list, finite map, or
    set of such objects. The implementation is not given directly, but
    we give a high-level description of how it relies on the underlying
    ordering. For each of these, it computes the index as follows:

    -   certificates in the DCert list are indexed in the order in which
        > they arranged in the (full, unfiltered) list of certificates
        > inside the transaction

    -   the index of a reward account *ract* in the reward withdrawals
        > map is the index of *ract* as a key in the (unfiltered) map.
        > The keys of the Wdrl map are arranged in the order defined on
        > the RewardAcnt type, which is a lexicographical order on the
        > pair of the Network and the Credential.

    -   the set of inputs is ordered according to the lexicographical
        > order on the type TxIn, and the index is the index of the list
        > obtained from this ordering.

    -   as with the inputs, the set of policy IDs is ordered
        > lexicographically and the index is derived from the list
        > obtained from this ordering.

> Note that in all the orderings above, long and short lex are one in
> the same, since for each of the ordered types, all the terms of that
> type have the same length.

-   indexedRdmrs indexes the pair of a redeemer and an ExUnits value for
    a given script by its script purpose (eg. the input, or certificate,
    etc.), and *◊* if no associated data is found. It uses the script
    purpose to generate the RdmrPtr key, then find the corresponding
    entry in the redeemer structure.

-   rdptr builds a redeemer pointer from a script purpose by setting the
    tag according to the type of the script purpose, and the index
    according to the placement of script purpose inside its container
    (ie. by using indexof)

> *Global Constants*
>
> *Abstract Types Derived types*
>
> EI *∈* EpochInfo Alonzo epoch info
>
> SysSt *∈* SystemStartSystem start time
>
> *tm ∈* UTCTimeSystem time
>
> *sp ∈* ScriptPurpose = PolicyID *⊎* TxIn *⊎* Addr~rwd~ *⊎* DCert
>
> *Abstract functions*
>
> indexOf : DCert *→* DCert*^∗^ →* Ix^?^ indexOf : Addr~rwd~ *→* Wdrl
> *→* Ix^?^ indexOf : TxIn *→* P TxIn *→* Ix^?^ indexOf : PolicyID *→* P
> PolicyID *→* Ix^?^
>
> *Indexing functions*
>
> indexedRdmrs : Tx *→* ScriptPurpose *→* (Redeemer *×* ExUnits)^?^
>
> indexedRdmrs *tx sp* = *r* (rdptr *txb sp*) *1→ r ∈* txrdmrs (txwits
> *tx*)*}*

-   otherwise

> **where**
>
> *txb* = txbody *tx*
>
> rdptr : TxBody *→* ScriptPurpose *→* RdmrPtr^?^
>
> (Cert, indexOf *sp* (txcerts *txb*)) *sp ∈* DCert rdptr *txb sp* =
> (Rewrd, indexOf *sp* (txwdrls *txb*)) *sp ∈* Addr~rwd~
>
> (Mint, indexOf *sp* (dom(mint *txb*))) *sp ∈* PolicyID
>
> (Spend, indexOf *sp* (txinputs *txb*)) *sp* []{#_bookmark18
> .anchor}*∈* TxIn
>
> **Figure 5:** Indexing script and data objects

## Plutus Script Validation

> Figure [6](#_bookmark20) shows the abstract functions that are used
> for script validation. In this figure, the function txInfo, which
> creates a summary of the transaction and ledger state as a TxInfo, is
> defined in Section [A](#txinfo-construction), as is the TxInfo type
> itself. The function valContext, also defined in
> [A](#txinfo-construction), constructs the validation context from the
> TxInfo summary.

-   epochInfoSlotToUTCTime translates a slot number to system time if
    possible. This trans- lation is implemented by the consensus
    algorithm (not the ledger), and requires two additional parameters
    to do this. Note that this does not depend on the clock of the node.

> If it is not possible to do this translation, *◊* is returned. The
> reason it may not be possible to translate is that the slot number is
> too far in the future for the system to accurately predict the exact
> time to which it refers.

-   runPLCScript validates Plutus scripts. It takes the following
    > arguments:

    -   A cost model, that is used to calculate the ExUnits that are
        > needed for script execution;

    -   A script to execute;

    -   the execution unit budget; and

    -   A list of terms of type Data that will be passed to the script.

> It outputs the validation result. Note that script execution stops if
> the full budget has been spent before validation is complete. It is
> left abstract because it is implemented as part of the phase-1 script
> interpreter, not the ledger. The interpreter called depends on the
> language of the script.
>
> **Slot to time translation.** One of the inputs to scripts is the
> transaction validity interval (recall here that they do not actually
> see the current slot number). The length of a slot may change in a
> future era. In this case, for a script written in a previous era, if
> we were to pass the transaction validity interval expressed as slot
> numbers, we get that

-   the script logic is expressed in terms of slot numbers which likely
    assume the slot length of the era in which it was created

-   the slot numbers in the validity interval of the transaction are
    used assuming slot length of the current era

> Therefore, the slot numbers inside the contract and the slot numbers
> in the transaction map differently onto points in time. The ledger
> does not have access to data (or conversion functions) that is needed
> to convert transaction validity interval slots numbers to slots
> numbers that correspond to the contracts world view. To address this,
> we decided to pass phase-2 contracts (in all languages and all eras)
> the system time instead of slot numbers. The conversion function is
> implemented by consensus (see [de Vries et al.](#_bookmark43)
> ([2021](#_bookmark43))), which has the information to do this
> correctly for

-   all slots prior to the current slot

-   a number of slots after the current slot (this number is determined
    by the consensus's forecast window)

> Note that because of this potential slot length change issue, Plutus
> scripts will not receive any information in terms of slot numbers (no
> phase-1 scripts, no validity intervals as slots, and not the current
> slot). Phase-1 timelock scripts continue to operate on validity
> interval data expressed as slot numbers, and are therefore vulnerable
> to the consequences of changing the slot length.
>
> **Validation context construction.** As additional phase-2 scripting
> languages become sup- ported in the future, scripts of different
> languages may expect different (or differently structured) transaction
> and ledger data summary. The txInfo function will be implemented
> differently for each new language. So, the construction is dependent
> on both the language of the script being validated and the
> ledger/transaction structure of the current era.
>
> In order to ensure that running scripts of all script languages is
> supported indefinitely across future eras, the txInfo function must be
> total. Recall here that while *running* all scripts must be supported
> across all future ledger changes, it is not a requirement that every
> script must *validate* within the context of some transaction.
>
> The txInfo output is computed once for the whole transaction. The
> output of the function valContext is computed separately for each
> script purpose. The script purpose is passed to it to allow the script
> to reference itself via its hash, and to be aware of what it is
> validating.
>
> **Know your contract arguments.** A Plutus validator script may
> receive either a list of three
>
> terms of type Data, in case it validates the spending of script
> outputs or two terms (redeemer and context, with no datum), for all
> other uses. Script authors must keep this in mind when writing
> scripts, since the ledger call to the interpreter is oblivious to what
> arguments are required.
>
> The following is a summary of what arguments are required for what
> scripts:

-   Datum objects are required for all output-locking phase-2 scripts.
    That is, a phase-2 script-locked output that does not include a
    datum hash is unspendable.

-   Non-output locking scripts do not expect datum objects - that is, it
    is not possible to pass a datum to a script used for another purpose
    (certificate, etc.).

-   Redeemers are required for all phase-2 scripts.

> If a transaction carrying a Plutus script is missing any inputs
> required to run a script, we have specified this to be a phase 1
> ledger failure, and the script is never run (even if its code does not
> look at the missing input). The reason for this approach is that not
> passing all inputs results in a script never actually getting run,
> rather than running and failing.
>
> []{#_bookmark20 .anchor}**Figure 6:** Script Validation, cont.
>
> Figure [7](#_bookmark22) contains the functions used to match scripts
> with their corresponding inputs and pass them to the evaluator.

-   getDatum looks for a datum associated with a given script purpose.
    > Note that only an TxIn-type script purpose can result in finding
    > an associated datum hash. If no datum is found, an empty list is
    > returned. A list containing the found datum is returned otherwise.

-   collectTwoPhaseScriptInputs builds a list of scripts, paired with
    their inputs. Specifically, each tuple in the list contains :

    -   the script, only if it is a phase-2 one;

    -   a list of the following script arguments, in this order:

        -   the hash of the required datum, if any (returned by the
            > getDatum function, wrapped in a list type instead of a
            > Data^?^ type).

        -   a redeemer, returned as the first term of the pair by the
            > indexedRdmrs function. and an ExUnits amount. We are
            > assuming this value is not *◊* here because that must have
            > already been checked by the UTXOW rule.

        -   the validation context, built by the valContext function
            > using the transaction summary built by txInfo, together
            > with the current item being validated;

    -   an ExUnits amount, which is the second term of the pair returned
        > by the indexedRdmrs

> function.

-   the cost model for PlutusV1, specified in the protocol parameters

```{=html}
<!-- -->
```
-   evalScripts evaluates a whole list of scripts. For PlutusV1 scripts,
    it evaluates them paired with all their inputs by calling the
    phase-2 script validator function, runPLCScript (see
    [A](#txinfo-construction) for details). For phase-1 (timelock)
    scripts, it calls evalTimelock. This case is unused though, as the
    list of scripts and inputs that gets passed to the this function is
    constructed to contain only Plutus scripts. So, phase-1 scripts do
    not get evaluated twice.

> Note that no "checks" are performed within these functions (though
> they may be, in the implementation). Missing validators, missing
> inputs, incorrect hashes, the wrong type of script etc, are caught
> during the application of the UTXOW rule (before these functions are
> ever applied).

## Two-Phase Transaction Validation for Phase-2 Scripts

> Transactions are validated in two phases: the first phase consists of
> every aspect of transaction validation apart from executing the
> phase-2 scripts; and the second phase involves actually executing
> those scripts. This ensures that users pay for the computational
> resources that are needed to validate phase-2 scripts, even if script
> validation fails. In order to handle script execution, an additional
> transition system is used, called UTXOS. It performs the appropriate
> UTxO state changes, based on the value of the IsValid tag, which it
> checks using the evalScripts function.
>
> In general, there is no way to check *a-priori* that the budget that
> has been supplied is sufficient
>
> for the transaction. This can only be done by actually running the
> scripts. From the perspective of the ledger, there is no difference
> between a script that exhausts the ExUnits budget during validation,
> and one that fails to validate.
>
> **Transaction integrity and charging for failing scripts.** If a
> transaction contains a failing
>
> script, the only change to the ledger that is made is that the
> collateral is collected into the fee pot. It is important to note here
> that it can be the case that the only signatures on a transaction are
> those of the keys for the collateral UTxOs (but this must include at
> least one signature).
>
> The implication of this is that the collateral key owners may be the
> only users that attest to the integrity of the data in the body of the
> transaction. These same key owners, however, are also the only users
> who stand to lose money if the transaction is modified in some way
> that results in phase-2 failure. Transactions with the same body will
> necessarily have the same outcome of phase-2 script validation (we
> give the details in the deterministic script validation property,
> [C.8](#_bookmark62)). Therefore, signing the body ensures any
> modification to any part of a transaction (including witnesses, etc.)
> or update to the ledger state that affect the transaction's validity
> will result in a
>
> **Figure 7:** Scripts and their arguments
>
> phase-1 failure, and no collateral collected. The implication of this
> is that the collateral-locking keys have full control over the outcome
> of phase-2 validation.
>
> **The** IsValid **Tag.** It is always in the interest of the slot
> leader to have the new block validate,
>
> and for it to contain only valid transactions. This motivates the slot
> leader to:

1.  Correctly apply the IsValid tag;

2.  Include all transactions that validate within the block, *even when
    there is a 2nd phase script validation failure*;

3.  Exclude any transactions that are phase-1 invalid

> One important reason for adding the validation tag to a transaction is
> that re-applying blocks will not require repeat execution of scripts
> in the transactions inside a block, which would increase execution
> costs. In fact, when replaying blocks, all the witnessing information
> can be thrown away.

## The UTXOS transition system

> We have defined a separate transition system, UTXOS, to represent the
> two distinct UTxO state changes: i) when all the scripts in a
> transaction validate; and ii) when at least one fails to validate. Its
> transition types are identical to the UTXO transition (Figure
> [8](#_bookmark24)).
>
> []{#_bookmark24 .anchor}**Figure 8:** UTxO script state update types
>
> There are two rules, corresponding to the two possible state changes
> of the UTxO state in the UTXOS transition system (Figure
> [9](#_bookmark25)). In both cases, the evalScripts function is called
> upon to verify that the IsValid tag has been applied correctly. The
> function collectTwoPhaseScriptInputs is used to build the input list
> *sLst* for the evalScripts function. The first rule applies when the
> validation tag is True. In this case, the states of the UTxO, fee and
> deposit pots, and updates are updated exactly as in the current
> Shelley ledger spec. The second rule applies when the validation tag
> is False. In this case, the UTxO state changes as follows:

1.  All the UTxO entries corresponding to the collateral inputs are
    removed;

2.  The sum total of the value of the collateral UTxO entries is added
    to the fee pot.

> **Figure 9:** State update rules
>
> Figure [10](#_bookmark27) shows the UTxO inductive transition rule for
> the UTXO transition type. This rule has the following changes:

1.  The transaction pays fees and supplies collateral Ada correctly, as
    defined above;

2.  The end of the transaction validity interval is translatable into
    system time (ie. within the consensus's forecast window). This is
    checked by epochInfoSlotToUTCTime, which returns

    -   if the end slot is outside. Note that we do not need to check
        that the start slot can be converted to time, because all pasts
        slots can be converted into time correctly.

3.  coinsPerUTxOWord is now a protocol parameter explicitly, the
    utxoEntrySize calculation is defined differently than for ShelleyMA
    (see Section [B](#output-size))

4.  maxValSize is now also a protocol parameter (not a constant). It
    represents a size (in bytes) of the total transaction size that the
    size of a Value in an output can be. Otherwise, this check is the
    same as in ShelleyMA.

5.  The network ID field in the transaction body must match the network
    ID constant

6.  The execution unit budget for a transaction is within the maximum
    permitted number of units for a transaction;

7.  The number of maximum allowed collateral inputs is not exceeded

8.  The UTXOS state transition is valid (this is the transition that
    runs the phase-2 scripts) The resulting state transition is defined
    entirely by the application of the UTXOS rule.

    1.  ## Witnessing

> Because of two-phase transaction validation, phase-2 script validation
> is not part of phase one of transaction witnessing (it is done in
> phase 2, once the rest of the transaction is validated). However,
> phase-1 script validation does remain part of transaction witnessing.
> When witnessing a transaction in phase one, we therefore need to
> validate only the phase-1 scripts.
>
> We construct the following helper functions :

-   witsVKeyNeeded is a Shelley function adjusted to include keys that
    are specified in the reqSignerHashes field of the transaction, as
    well as keys locking the UTxOs to which the collateral inputs of the
    transaction point.

-   scriptsNeeded assembles the all the ScriptPurpose terms for
    validation of every transac- tion action that requires script
    validation, paired with the hashes of corresponding the witnessing
    scripts. This function collects hashes of both phase-1 and phase-2
    scripts.

-   languages returns the set of (phase-2) script languages of all the
    scripts included in the transaction

> We have made the following changes and additions to the UTXOW
> preconditions:

-   All the phase-1 scripts in the transaction validate;

-   The transaction contains exactly those scripts that are required for
    witnessing and no additional ones;

-   The datums included in the witnesses contain all the datums required
    > for validating in phase 2. That is, datums for all output-locking
    > phase-2 scripts for the payment credentials of the addresses of
    > the UTxOs the transaction is spending must have attached datum
    > objects. This check will also fail if the datum hash fields of
    > such UTxOs are *◊*, as *◊* is not a hash of a datum (and therefore
    > is not a key of the DataHash-indexed map).

-   The only datums included in a transaction have hashes that are
    either in a UTxO corre- sponding to a transaction input, or in a
    transaction output. The output datums are for communication only,
    and are therefore optional, hence the use of subset equality. No
    additional datums are permitted. We call the datums corresponding to
    the inputs the **required datums** and the datums corresponding to
    the outputs the **supplemental datums**.

+---------+----------+------------+--------------+--------+---------+
|         | > *txb*  |            |              |        |         |
|         | > :=     |            |              |        |         |
|         | > txbody |            |              |        |         |
|         | > *tx*   |            |              |        |         |
|         | > in     |            |              |        |         |
|         | interval |            |              |        |         |
|         | > *slot* |            |              |        |         |
|         | >        |            |              |        |         |
|         |  (txvldt |            |              |        |         |
|         | > *txb*) |            |              |        |         |
|         | > ( ,    |            |              |        |         |
|         | > *i~f~* |            |              |        |         |
|         | > ) :=   |            |              |        |         |
|         | > txvldt |            |              |        |         |
|         | > *tx*   |            |              |        |         |
|         | >        |            |              |        |         |
|         | > *◊ ∈*/ |            |              |        |         |
|         | > *{     |            |              |        |         |
|         | *txrdmrs |            |              |        |         |
|         | > *tx*,  |            |              |        |         |
|         | > *i~f~  |            |              |        |         |
|         | > } ⇒*   |            |              |        |         |
|         | > epochI |            |              |        |         |
|         | nfoSlotT |            |              |        |         |
|         | oUTCTime |            |              |        |         |
|         | > EI     |            |              |        |         |
|         | > SysSt  |            |              |        |         |
|         | > *i~f~  |            |              |        |         |
|         | > ̸*=     |            |              |        |         |
|         | > *◊*    |            |              |        |         |
|         | >        |            |              |        |         |
|         | > txins  |            |              |        |         |
|         | > *txb   |            |              |        |         |
|         | > ̸*= ∅   |            |              |        |         |
|         | > feesOK |            |              |        |         |
|         | > *pp tx |            |              |        |         |
|         | > utxo*  |            |              |        |         |
|         | > txins  |            |              |        |         |
|         | > *txb   |            |              |        |         |
|         | > ∪*     |            |              |        |         |
|         | > co     |            |              |        |         |
|         | llateral |            |              |        |         |
|         | > *txb   |            |              |        |         |
|         | > ⊆* dom |            |              |        |         |
|         | > *utxo* |            |              |        |         |
|         | >        |            |              |        |         |
|         | >        |            |              |        |         |
|         | consumed |            |              |        |         |
|         | > *pp    |            |              |        |         |
|         | > utxo   |            |              |        |         |
|         | > txb*   |            |              |        |         |
|         | > =      |            |              |        |         |
|         | produced |            |              |        |         |
|         | > *pp    |            |              |        |         |
|         | > po     |            |              |        |         |
|         | olParams |            |              |        |         |
|         | > txb*   |            |              |        |         |
|         | >        |            |              |        |         |
|         | > adaID  |            |              |        |         |
|         | > *∈*/   |            |              |        |         |
|         | > supp   |            |              |        |         |
|         | > mint   |            |              |        |         |
|         | > *tx*   |            |              |        |         |
|         | >        |            |              |        |         |
|         | >        |            |              |        |         |
|         |  *∀txout |            |              |        |         |
|         | > ∈*     |            |              |        |         |
|         | > txouts |            |              |        |         |
|         | > *txb*, |            |              |        |         |
|         | >        |            |              |        |         |
|         | >        |            |              |        |         |
|         | getValue |            |              |        |         |
|         | > *txout |            |              |        |         |
|         | > ≥*     |            |              |        |         |
|         | > inject |            |              |        |         |
|         | > (      |            |              |        |         |
|         | > utxoE  |            |              |        |         |
|         | ntrySize |            |              |        |         |
|         | > *txout |            |              |        |         |
|         | > ∗*     |            |              |        |         |
|         | >        |            |              |        |         |
|         | coinsPer |            |              |        |         |
|         | UTxOWord |            |              |        |         |
|         | > *pp*)  |            |              |        |         |
|         | >        |            |              |        |         |
|         | >        |            |              |        |         |
|         |  *∀txout |            |              |        |         |
|         | > ∈*     |            |              |        |         |
|         | > txouts |            |              |        |         |
|         | > *txb*, |            |              |        |         |
|         | >        |            |              |        |         |
|         | >        |            |              |        |         |
|         |  serSize |            |              |        |         |
|         | > (      |            |              |        |         |
|         | getValue |            |              |        |         |
|         | >        |            |              |        |         |
|         | *txout*) |            |              |        |         |
|         | > *≤*    |            |              |        |         |
|         | > ma     |            |              |        |         |
|         | xValSize |            |              |        |         |
|         | > *pp*   |            |              |        |         |
|         | >        |            |              |        |         |
|         | > *∀*(   |            |              |        |         |
|         | > *1→*   |            |              |        |         |
|         | > (*a*,  |            |              |        |         |
|         | > )) *∈* |            |              |        |         |
|         | > txouts |            |              |        |         |
|         | > *txb*, |            |              |        |         |
|         | > *a ∈*  |            |              |        |         |
|         | >        |            |              |        |         |
|         |  Addr~bo |            |              |        |         |
|         | otstrap~ |            |              |        |         |
|         | > *⇒*    |            |              |        |         |
|         | > bo     |            |              |        |         |
|         | otstrapA |            |              |        |         |
|         | ttrsSize |            |              |        |         |
|         | > *a ≤*  |            |              |        |         |
|         | > 64     |            |              |        |         |
|         | >        |            |              |        |         |
|         | > *∀*(   |            |              |        |         |
|         | > *1→*   |            |              |        |         |
|         | > (*a*,  |            |              |        |         |
|         | > )) *∈* |            |              |        |         |
|         | > txouts |            |              |        |         |
|         | > *txb*, |            |              |        |         |
|         | > netId  |            |              |        |         |
|         | > *a* =  |            |              |        |         |
|         | > N      |            |              |        |         |
|         | etworkId |            |              |        |         |
|         | >        |            |              |        |         |
|         | > *∀*(*a |            |              |        |         |
|         | > 1→* )  |            |              |        |         |
|         | > *∈*    |            |              |        |         |
|         | >        |            |              |        |         |
|         |  txwdrls |            |              |        |         |
|         | > *txb*, |            |              |        |         |
|         | > netId  |            |              |        |         |
|         | > *a* =  |            |              |        |         |
|         | > N      |            |              |        |         |
|         | etworkId |            |              |        |         |
|         | >        |            |              |        |         |
|         | > (txn   |            |              |        |         |
|         | etworkid |            |              |        |         |
|         | > *txb*  |            |              |        |         |
|         | > =      |            |              |        |         |
|         | > Ne     |            |              |        |         |
|         | tworkId) |            |              |        |         |
|         | > *∨*    |            |              |        |         |
|         | > (txn   |            |              |        |         |
|         | etworkid |            |              |        |         |
|         | > *txb*  |            |              |        |         |
|         | > = *◊*) |            |              |        |         |
|         | >        |            |              |        |         |
|         | > txsize |            |              |        |         |
|         | > *tx ≤* |            |              |        |         |
|         | > m      |            |              |        |         |
|         | axTxSize |            |              |        |         |
|         | > *pp*   |            |              |        |         |
|         | >        |            |              |        |         |
|         | > to     |            |              |        |         |
|         | tExunits |            |              |        |         |
|         | > *tx ≤* |            |              |        |         |
|         | > maxT   |            |              |        |         |
|         | xExUnits |            |              |        |         |
|         | > *pp    |            |              |        |         |
|         | > ∥*co   |            |              |        |         |
|         | llateral |            |              |        |         |
|         | > *tx∥   |            |              |        |         |
|         | > ≤*     |            |              |        |         |
|         | > max    |            |              |        |         |
|         | Collater |            |              |        |         |
|         | alInputs |            |              |        |         |
|         | > *pp*   |            |              |        |         |
+=========+==========+============+==============+========+=========+
| >       |          | > *slot*  | > *utxo*   | > *    |         |
| UTxO-in |          | >          | >            | utxo′* |         |
| ductive |          | > *pp      | > *deposits  | >     |         |
|         |          | >          | > tx*        | >      |         |
|         |          | poolParams | >            | >      |         |
|         |          | > ⊢*     | > *fees*   |  *depo |         |
|         |          | >          | > *−*U*      | sits′* |         |
|         |          | > *        | −*T*−*XO*→*S | >      |         |
|         |          | genDelegs* | >          | > *    |         |
|         |          |            | >            | fees′* |         |
|         |          |            | > *pup*      | >    |         |
|         |          |            |              | >      |         |
|         |          |            |              | >      |         |
|         |          |            |              | *pup′* |         |
+---------+----------+------------+--------------+--------+---------+
|         |          | > *slot*  | > *utxo*   | >      | \(3\)   |
|         |          | >          | >            |  ***ut |         |
|         |          | > *pp*     | > *deposits  | xo′*** |         |
|         |          | >          | > tx*        | >     |         |
|         |          | > *        | >            | >      |         |
|         |          | poolParams | > *fees*   | > ***  |         |
|         |          | > ⊢*       | > *−*U*      | deposi |         |
|         |          | > []{#_   | **−***TX*→*O | ts′*** |         |
|         |          | bookmark27 | >          | >      |         |
|         |          | >          | >            | >      |         |
|         |          |  .anchor} | > *pup*      |  ***fe |         |
|         |          | >          |              | es′*** |         |
|         |          | > *        |              | >    |         |
|         |          | genDelegs* |              | >      |         |
|         |          |            |              | > ***p |         |
|         |          |            |              | up′*** |         |
+---------+----------+------------+--------------+--------+---------+

> **Figure 10:** UTxO inference rules

-   For every item that needs to be validated by a phase-2 script, and
    > that phase-2 script is present, the transaction contains an entry
    > in the indexed redeemer structure (ie. the execution units and
    > redeemer for it are specified). Note here that if the full script
    > is not present, we cannot tell from the hash that the script is
    > phase-2, and therefore requires a redeemer;

-   Each redeemer pointer in the indexed redeemer structure corresponds
    to a pointer con- structed using rdptr from some script purpose of a
    phase-2 script of the transaction. This ensures that there are no
    additional entries present in the structure (ie. those that are not
    required for validation of any script);

-   The signatures of the keys whose hashes are specified in the
    reqSignerHashes field in a transaction have all indeed signed it;

-   The hash of the subset of protocol parameter values and witnessing
    data that have been included in the transaction body is the same as
    the hash of the witness data and the subset

> []{#_bookmark28 .anchor}**Figure 11:** UTXOW helper functions
>
> of protocol parameters that are currently contained in the ledger;
>
> If these conditions are all satisfied, then the resulting UTxO state
> change is fully determined by the UTXO transition (the application of
> which is also part of the conditions).
>
> []{#_bookmark29 .anchor}**Figure 12:** UTxO with witnesses state
> update types

+------+---+----------------------------------------+-----+------+---+---+
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | b |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | : |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | b |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | : |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | , |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | , |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | , |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | : |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | S |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | K |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | H |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | : |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | { |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | K |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | v |                                        |     |      |   |   |
|      | k |                                        |     |      |   |   |
|      | \ |                                        |     |      |   |   |
|      | | |                                        |     |      |   |   |
|      | v |                                        |     |      |   |   |
|      | k |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ∈ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | m |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | V |                                        |     |      |   |   |
|      | K |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | } |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
+======+===+========================================+=====+======+===+===+
|      |   | > *inputHashes* := *{h \|* ( *1→*      |     |      | * |   |
|      |   | > (*a*, , *h*)) *∈* txins *txb \<l     |     |      | a |   |
|      |   | > utxo*, isTwoPhaseScriptAddress *tx*  |     |      | } |   |
|      |   |                                        |     |      | * |   |
+------+---+----------------------------------------+-----+------+---+---+
|      | > |                                        |     |      | > |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      | * |   |
|      | ∀ |                                        |     |      | t |   |
|      | s |                                        |     |      | x |   |
|      | > |                                        |     |      | w |   |
|      |   |                                        |     |      | * |   |
|      | ∈ |                                        |     |      | ) |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | n |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | c |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ∩ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | S |                                        |     |      |   |   |
|      | c |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | ^ |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | 1 |                                        |     |      |   |   |
|      | ^ |                                        |     |      |   |   |
|      | , |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | v |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | l |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | S |                                        |     |      |   |   |
|      | c |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | { |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | \ |                                        |     |      |   |   |
|      | | |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | , |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ∈ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | c |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | N |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | b |                                        |     |      |   |   |
|      | } |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | m |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | c |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | n |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | H |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ⊆ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | m |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | m |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ⊆ |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | n |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | H |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ∪ |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | { |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | \ |                                        |     |      |   |   |
|      | | |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | , |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | , |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ∈ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | } |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | m |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | m |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | { |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | b |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | \ |                                        |     |      |   |   |
|      | | |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | , |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ∈ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | c |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | N |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | b |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | , |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | 1 |                                        |     |      |   |   |
|      | → |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ∈ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | c |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | , |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ∈ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | S |                                        |     |      |   |   |
|      | c |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | ^ |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | 2 |                                        |     |      |   |   |
|      | ^ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | } |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | b |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | H |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | : |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | b |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ∀ |                                        |     |      |   |   |
|      | v |                                        |     |      |   |   |
|      | k |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | 1 |                                        |     |      |   |   |
|      | → |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | σ |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ∈ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | V |                                        |     |      |   |   |
|      | K |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | , |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | V |                                        |     |      |   |   |
|      | ~ |                                        |     |      |   |   |
|      | v |                                        |     |      |   |   |
|      | k |                                        |     |      |   |   |
|      | ~ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | \ |                                        |     |      |   |   |
|      | [ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | b |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | H |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | \ |                                        |     |      |   |   |
|      | ] |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | σ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | V |                                        |     |      |   |   |
|      | K |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | N |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | n |                                        |     |      |   |   |
|      | D |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | l |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ⊆ |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | K |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | H |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | n |                                        |     |      |   |   |
|      | S |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | : |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | { |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | K |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | k |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | \ |                                        |     |      |   |   |
|      | | |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | k |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ∈ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | m |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | n |                                        |     |      |   |   |
|      | D |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | l |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | } |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ∩ |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | K |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | H |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | { |                                        |     |      |   |   |
|      | c |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ∈ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | c |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | b |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ∩ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | D |                                        |     |      |   |   |
|      | C |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | ~ |                                        |     |      |   |   |
|      | m |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | ~ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | } |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ̸* |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ∅ |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ⇒ |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | \ |                                        |     |      |   |   |
|      | | |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | n |                                        |     |      |   |   |
|      | S |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | \ |                                        |     |      |   |   |
|      | | |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ≥ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | Q |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | m |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | : |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | A |                                        |     |      |   |   |
|      | D |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | b |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | : |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | l |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | D |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ◊ |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ∧ |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ◊ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ∨ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | A |                                        |     |      |   |   |
|      | D |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | l |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | n |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ⊆ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | m |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | c |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | m |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | l |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | c |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | I |                                        |     |      |   |   |
|      | n |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | H |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | b |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | = |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | h |                                        |     |      |   |   |
|      | S |                                        |     |      |   |   |
|      | c |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | I |                                        |     |      |   |   |
|      | n |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | i |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | y |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | l |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | n |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | m |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | w |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | d |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | l |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | p |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | l |                                        |     |      |   |   |
|      | P |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | m |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | ⊢ |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | S |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | − |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | [ |                                        |     |      |   |   |
|      | U |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | − |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | T |                                        |     |      |   |   |
|      | X |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | → |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | O |                                        |     |      |   |   |
|      | ] |                                        |     |      |   |   |
|      | ( |                                        |     |      |   |   |
|      | # |                                        |     |      |   |   |
|      | _ |                                        |     |      |   |   |
|      | b |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | k |                                        |     |      |   |   |
|      | m |                                        |     |      |   |   |
|      | a |                                        |     |      |   |   |
|      | r |                                        |     |      |   |   |
|      | k |                                        |     |      |   |   |
|      | 2 |                                        |     |      |   |   |
|      | 7 |                                        |     |      |   |   |
|      | ) |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | u |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | x |                                        |     |      |   |   |
|      | o |                                        |     |      |   |   |
|      | S |                                        |     |      |   |   |
|      | t |                                        |     |      |   |   |
|      | ′ |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      | > |                                        |     |      |   |   |
|      |   |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | n |                                        |     |      |   |   |
|      | D |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | l |                                        |     |      |   |   |
|      | e |                                        |     |      |   |   |
|      | g |                                        |     |      |   |   |
|      | s |                                        |     |      |   |   |
|      | * |                                        |     |      |   |   |
+------+---+----------------------------------------+-----+------+---+---+
| > U  |   |                                        |     |      |   |   |
| TxO- |   |                                        |     |      |   |   |
| witG |   |                                        |     |      |   |   |
+------+---+----------------------------------------+-----+------+---+---+
|      |   | > *slot*                               | > * | []{  |   |   |
|      |   | >                                      | **′ | #_bo |   |   |
|      |   | > *pp tx*                              | *** | okma |   |   |
|      |   | >                                      |     | rk30 |   |   |
|      |   | > *poolParams ⊢ utxoSt                 |     | .an  |   |   |
|      |   | > −*U*−*T*−*X*−*O*→*W ***utxoSt***     |     | chor |   |   |
|      |   | >                                      |     | }(4) |   |   |
|      |   | > *genDelegs*                          |     |      |   |   |
+------+---+----------------------------------------+-----+------+---+---+

> **Figure 13:** UTxO with witnesses inference rules for Tx

# Ledger State Transition

> Figure [14](#_bookmark32) separates the case where all the scripts in
> a transaction successfully validate from the case where there is one
> or more that does not. These two cases are distinguished by the use of
> the IsValid tag. Besides collateral collection, no side effects should
> occur when processing a transaction that contains a script that does
> not validate. That is, no delegation or pool state updates, update
> proposals, or any other observable state change, should be applied.
> The UTxO rule is still applied, however, as this is where the
> correctness of the validation tag is verified, and where collateral
> inputs are collected.
>
> **Figure 14:** Ledger inference rules

6.  # Blockchain layer

    1.  ## Block Body Transition

> Figure [15](#_bookmark35) includes an additional check that the sum of
> the execution units of all transactions in a block does not exceed the
> maximum total units per block (specified in a protocol parameter).

+------+--------+----+----+---------------------------------------+---+
| > Bl | >      |    |    |                                       |   |
| ock- |  *txs* |    |    |                                       |   |
| Body | > :=   |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      |  bbody |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      | *block |    |    |                                       |   |
|      | > bhb* |    |    |                                       |   |
|      | > :=   |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      | bhbody |    |    |                                       |   |
|      | > (b   |    |    |                                       |   |
|      | header |    |    |                                       |   |
|      | > *b   |    |    |                                       |   |
|      | lock*) |    |    |                                       |   |
|      | > *hk* |    |    |                                       |   |
|      | > :=   |    |    |                                       |   |
|      | > h    |    |    |                                       |   |
|      | ashKey |    |    |                                       |   |
|      | > (b   |    |    |                                       |   |
|      | vkcold |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      | *bhb*) |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      | > bBo  |    |    |                                       |   |
|      | dySize |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      |  *txs* |    |    |                                       |   |
|      | > =    |    |    |                                       |   |
|      | > h    |    |    |                                       |   |
|      | Bbsize |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      |  *bhb* |    |    |                                       |   |
|      | > bbo  |    |    |                                       |   |
|      | dyhash |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      |  *txs* |    |    |                                       |   |
|      | > =    |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      |  bhash |    |    |                                       |   |
|      | > *bhb |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      |  slot* |    |    |                                       |   |
|      | > :=   |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      |  bslot |    |    |                                       |   |
|      | > *bhb |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      | fSlot* |    |    |                                       |   |
|      | > :=   |    |    |                                       |   |
|      | > fir  |    |    |                                       |   |
|      | stSlot |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      | (epoch |    |    |                                       |   |
|      | > *    |    |    |                                       |   |
|      | slot*) |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      |  ∑*~tx |    |    |                                       |   |
|      | ∈txs~* |    |    |                                       |   |
|      | > totE |    |    |                                       |   |
|      | xunits |    |    |                                       |   |
|      | > *tx  |    |    |                                       |   |
|      | > ≤*   |    |    |                                       |   |
|      | > max  |    |    |                                       |   |
|      | BlockE |    |    |                                       |   |
|      | xUnits |    |    |                                       |   |
|      | > *pp* |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      |  bslot |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      |  *bhb* |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      | > *pp  |    |    |                                       |   |
|      | > ⊢ ls |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      |  **−** |    |    |                                       |   |
|      | −^txs^ |    |    |                                       |   |
|      | > →    |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      | ls^′^* |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      | >      |    |    |                                       |   |
|      | *acnt* |    |    |                                       |   |
|      | > L    |    |    |                                       |   |
|      | ED*−*G |    |    |                                       |   |
|      | *−*ERS |    |    |                                       |   |
+======+========+====+====+=======================================+===+
|      | > *pp  | >  | >  | > ( ***ls^′^***                       | > |
|      | > acnt |  ( |  * | >                                     |   |
|      | > ⊢*   | >  | bl | > **incrBlocks (isOverlaySlot *fSlot* | j |
|      |        | *l | oc | > (d *pp*) *slot*) *hk b***           | > |
|      |        | s* | k* |                                       | > |
|      |        | >  | >  |                                       |   |
|      |        |  j | >  |                                       | [ |
|      |        | >  |  * |                                       | ] |
|      |        | >  | −* |                                       | { |
|      |        |  * | B* |                                       | # |
|      |        | b* | −* |                                       | _ |
|      |        |    | BO |                                       | b |
|      |        |    | *− |                                       | o |
|      |        |    | *D |                                       | o |
|      |        |    | *→ |                                       | k |
|      |        |    | *Y |                                       | m |
|      |        |    |    |                                       | a |
|      |        |    |    |                                       | r |
|      |        |    |    |                                       | k |
|      |        |    |    |                                       | 3 |
|      |        |    |    |                                       | 5 |
|      |        |    |    |                                       | > |
|      |        |    |    |                                       |   |
|      |        |    |    |                                       | . |
|      |        |    |    |                                       | a |
|      |        |    |    |                                       | n |
|      |        |    |    |                                       | c |
|      |        |    |    |                                       | h |
|      |        |    |    |                                       | o |
|      |        |    |    |                                       | r |
|      |        |    |    |                                       | } |
|      |        |    |    |                                       | ( |
|      |        |    |    |                                       | 7 |
|      |        |    |    |                                       | ) |
+------+--------+----+----+---------------------------------------+---+

> **Figure 15:** BBody rules
>
> We have also defined a function that transforms the Shelley ledger
> state into the corre- sponding Alonzo one, see Figure
> [16](#_bookmark36). We refer to the Shelley-era protocol parameter
> type as ShelleyPParams, and the corresponding Alonzo type as PParams.
> We use the notation *chainstate~x~* to represent variable *x* in the
> chain state. We do not specify the variables that remain unchanged
> during the transition.
>
> []{#_bookmark36 .anchor}**Figure 16:** Shelley to Alonzo State
> Transtition

# MIR Certificates

> In the Alonzo era, MIR certs have:

-   Slightly different behavior - prior to the Alonzo era, MIR
    certificates within the same epoch override values for repeated
    stake addresses. In the Alonzo era, repetitions are handled by
    adding the values. Moreover, negative values are allowed, so long as
    the change never results in an overall negative sum. See Figure
    [18](#_bookmark39).

-   Extended functionality - MIR certificates can now be used to
    transfer funds between the reserves and the treasury. See Figure
    [19](#_bookmark40).

> Figure [17](#_bookmark38) describes the necessary changes to the
> types. Note that mirTarget was named credCoinMap in the Shelley
> specification. Figure [18](#_bookmark39) is a modification to the
> DELEG rule, and Figure [19](#_bookmark40) is an addition to the DELEG
> rule. Lastly, Figure [20](#_bookmark41) is the updated MIR rule.
>
> **Figure 17:** Alonzo Types for MIR updates
>
> **Figure 18:** Move Instantaneous Rewards Inference Rule
>
> **Figure 19:** MIR transfer Inference Rule
>
> (*rewards*, *delegations*, *ptrs*, *fGenDelegs*, *genDelegs*,
> *i~rwd~*) := *ds*
>
> (*treasury*, *reserves*) := *acnt*
>
> (*irReserves*, *irTreasury* , *deltaReserves*, *deltaTreasury* ) :=
> *i~rwd~*
>
> *irwdR* := *{*addr~rwd~ *hk 1→ val \| hk 1→ val ∈* (dom *rewards*)
> *\<l irReserves} irwdT* := *{*addr~rwd~ *hk 1→ val \| hk 1→ val ∈*
> (dom *rewards*) *\<l irTreasury} availableReserves* := *reserves* +
> *deltaReserves*
>
> *availableTreasury* := *treasury* + *deltaTreasury*

*totR* := ∑ *v totT* := ∑ *v*

*1→v∈irwdR 1→v∈irwdT*

MIR

> *enough* := *totR ≤* *availableReserves ∧ totT ≤* *availableTreasury*
>
> *acnt′* := (*treasury − totT*, *reserves − totR*) *enough acnt*
> otherwise
>
> *rewards′* := *rewards ∪*~+~ *irwdR ∪*~+~ *irwdT enough rewards*
> otherwise
>
> *ds′* := (***rewards^′^***, *delegations*, *ptrs*, *fGenDelegs*,
> *genDelegs*, (**∅**, **∅**, **0**, **0**))
>
> \(10\)
>
> 
>
> *⊢* []{#_bookmark41 .anchor}
>
> *acnt ss*
>
> (*us*, (*ds*, *ps*)) *prevPP*
>
> *pp*



> ***−***M*→*IR 
>
> ***acnt′***
>
> *ss*
>
> (*us*, (***ds′***, *ps*)) *prevPP*
>
> *pp*
>
> **Figure 20:** MIR rules

# References

> []{#_bookmark42 .anchor}Manuel MT Chakravarty, James Chapman, Kenneth
> MacKenzie, Orestis Melkonian, Michael Pey- ton Jones, and Philip
> Wadler. The extended utxo model. In *International Conference on
> Financial Cryptography and Data Security*, pages 525--539. Springer,
> 2020. URL
> [https:](https://iohk.io/en/research/library/papers/the-extended-utxo-model/)
>
> [//iohk.io/en/research/library/papers/the-extended-utxo-model/](https://iohk.io/en/research/library/papers/the-extended-utxo-model/).
>
> []{#_bookmark43 .anchor}Edsko de Vries, Thomas Winant, and Duncan
> Coutts. The Cardano Consensus and Storage Layer. Technical report,
> IOHK, 2021. URL
> [https://hydra.iohk.io/build/5265971/download/1/](https://hydra.iohk.io/build/5265971/download/1/report.pdf)
> [report.pdf](https://hydra.iohk.io/build/5265971/download/1/report.pdf).
>
> []{#_bookmark44 .anchor}Formal Methods Team, IOHK. A Formal
> Specification of a Multi-Signature Scheme using Scripts, 2019a. URL
> [https://github.com/input-output-hk/cardano-ledger/blob/master/eras/](https://github.com/input-output-hk/cardano-ledger/blob/master/eras/shelley/formal-spec/multi-sig.tex)
> [shelley/formal-spec/multi-sig.tex](https://github.com/input-output-hk/cardano-ledger/blob/master/eras/shelley/formal-spec/multi-sig.tex).
>
> []{#_bookmark45 .anchor}Formal Methods Team, IOHK. A Formal
> Specification of the Cardano Ledger with a Na- tive Multi-Asset
> Implementation, 2019b. URL
> [https://github.com/input-output-hk/](https://github.com/input-output-hk/cardano-ledger/tree/master/eras/shelley-ma/formal-spec/mary-ledger.tex)
> [cardano-ledger/tree/master/eras/shelley-ma/formal-spec/mary-ledger.tex](https://github.com/input-output-hk/cardano-ledger/tree/master/eras/shelley-ma/formal-spec/mary-ledger.tex).
>
> []{#_bookmark46 .anchor}Formal Methods Team, IOHK. A Formal
> Specification of the Cardano Ledger, 2019c. URL
> [https://github.com/input-output-hk/cardano-ledger/tree/master/eras/](https://github.com/input-output-hk/cardano-ledger/tree/master/eras/shelley/formal-spec/shelley-ledger.tex)
> [shelley/formal-spec/shelley-ledger.tex](https://github.com/input-output-hk/cardano-ledger/tree/master/eras/shelley/formal-spec/shelley-ledger.tex).
>
> []{#_bookmark47 .anchor}Plutus Team. Formal Specification of the
> Plutus Core Language, 2021a. URL
> [https://hydra.](https://hydra.iohk.io/build/7244320/download/1/plutus-core-specification.pdf)
> [iohk.io/build/7244320/download/1/plutus-core-specification.pdf](https://hydra.iohk.io/build/7244320/download/1/plutus-core-specification.pdf).
>
> []{#_bookmark48 .anchor}Plutus Team. The Plutus Platform: An IOHK
> technical report, 2021b. URL
> [https://hydra.](https://hydra.iohk.io/build/7244348/download/1/plutus.pdf)
> [iohk.io/build/7244348/download/1/plutus.pdf](https://hydra.iohk.io/build/7244348/download/1/plutus.pdf).

# TxInfo Construction

> This section specifies exactly what parts of the transaction and
> ledger state are used by the txInfo function to construct the TxInfo
> element that, together with the script purpose for which the script is
> being run, gets passed as a Data argument to the Plutus interpreter.

## Type Translations

> We give the Plutus types corresponding to the ledger counterparts in
> Figures [21](#_bookmark51) and [22](#_bookmark53). Details for types
> that have non-identity translation functions between ledger and Plutus
> types are in Figure [24](#_bookmark55).
>
> **Notation.** In this Section we use the notation P.PlutusType for the
> Plutus type PlutusType
>
> (specified in the Plutus library) to distinguish it from ledger types.
>
> If LT is a ledger type, and P.LT is the corresponding Plutus type to
> which elements of LT
>
> must be translated, we denote the translation function by:
>
> toPlutusType~LT~ : LT *→* P.LT
>
> As a shorthand, we always write *t~P~* for toPlutusType*LT t*, if *t*
> is of type LT.
>
> In many cases this function is simply the identity function, and all
> the cases in which it is not
>
> the identity will be described below.
>
> **Sets and maps.** Since the Data type is effectively a serialization,
> we need to make some arbitrary choices for how to encode certain types
> that aren't inherently ordered. We encode sets as lexicographically
> ordered lists, and maps in the same way by treating them first as sets
> of key-value pairs.
>
> **Untranslatable Types.** Certain types, such as the bootstrap address
> type, cannot be passed
>
> to scripts, and are therefore translated as *◊*. Any type that cannot
> be fully translated as a Plutus- library type is also translated to
> *◊*. For example, since a bootstrap address *a* Addr~bootstrap~ is not
> translatable, neither is *a* Addr, and (*a*, , ) TxOut also translates
> to *◊*.
>
> **Certificates.** Translating certain kinds of certificates drops the
> data in the certificates, in
>
> particular, the DCert~genesis~ and DCert~mir~ ones. The DCert~regpool~
> pool registration certificate has a non-identity translation function,
> transPoolCert.
>
> **Time Translation.** Functions needed to implement conversion of a
> slot number to POSIX
>
> time are given in Figure [23](#_bookmark54).
>
> **Time Range Translation.** Performed by transVITime given in Figure
> [23](#_bookmark54). In case when both upper and lower bounds are set
> to specific slots, resulting P.POSIXTimeRange will have non-strict
> lower bound and strict upper bound.
>
> **Value Translation. CAUTION**: Details provided here expose internals
> of the Value abstrac- tion. It is **strongly** recommended to use
> abstractions provided by the Plutus library, where these details are
> handled under the hood for the user by library functions. Providing
> these details aims to help developers with very specific needs, who
> understand the risk of bypassing
>
> abstractions provided by the library.
>
> During toPlutusTypeValue Value P.Value translation (Figure
> [23](#_bookmark54)), if there is no Ada in the Value, then translated
> P.Value will contain 0 Ada value, i.e. there will be P.Value with 0
> Ada in it. Consequently, TxInfo mint field will contain 0 Ada P.Value
> among other assets.
>
> **Pointer Address Resolution.** Note that the Ptr addresses translated
> and passed to Plutus scripts are not resolvable to their corresponding
> key or script staking credencials. This is because doing a lookup in
> the resolution map, which part of the ledger state, could break
> determinism. **Well-Formed Scripts and Data.** During the transaction
> encoding and decoding process, a transaction is discarded if it is not
> encoded correctly. This includes, in particular, a check that Script
> and Data elements contained in the transaction are well-formed.
> Functions that perfom
>
> these checks are in Figure [25](#_bookmark56). The P.validateScript
> function is a Plutus-library function which checks whether a
> bytestring represents a Plutus script.
>
> **Figure 21:** TxInfo and Constituent Types

## Building Transaction Summary

> The functions in Figure [26](#_bookmark57) are needed to build a Data
> summary of a transaction. The function
>
> P.toData converts a Plutus-library element into a Data element.
>
> **The** txInfo **Function.** txInfo summarizes all the necessary
> transaction and chain state infor- mation that needs to be passed to
> the script interpreter. Below, we specify how to represent relevant
> transaction data in terms of a Plutus library-defined type. The txInfo
> function builds this representation.
>
> The Language argument is required because different languages have
> different expectations of the format and contents of the TxInfo
> summary. The EpochInfo and SystemStart arguments
>
> []{#_bookmark53 .anchor}**Figure 22:** TxInfo and Constituent Types
>
> are needed for translating slot numbers to POSIX time.
>
> Note that txInfo has a UTxO argument. Even though the full ledger UTxO
> is passed to it, we define this function in such a way that the only
> entries in the ledger UTxO map that a Plutus script actually sees via
> the argument txInfo builds are the ones corresponding to the
> transaction inputs (ie. its realized inputs). This is done in order to
> maintain the locality of evaluation. For details, see the
> deterministic script evaluation property [C.8](#_bookmark62).
>
> **The** valContext **Function.** valContext constructs the *validation
> context*, also referred to as the
>
> script context. A validation context is a Data element which encodes
> both the summary of the transaction and ledger information (this is
> supplied by the txInfo summarization function), and the script
> purpose.
>
> []{#_bookmark54 .anchor}**Figure 23:** Types and Functions Used in
> Time Conversion
>
> []{#_bookmark55 .anchor}**Figure 24:** TxInfo Constituent Type
> Translation Functions
>
> []{#_bookmark56 .anchor}**Figure 25:** Script and Data construction
> correctness checks
>
> []{#_bookmark57 .anchor}**Figure 26:** Transaction Summarization
> Functions

# Output Size

> Figure [27](#_bookmark59) gives the formula for calculating the size
> of a UTxO entry in the Alonzo era. In addition to the data found in
> the UTxO in the ShelleyMA era, the hash of a datum (or *◊*) is added
> to the output type, which is accounted for in the size calculation.
>
> []{#_bookmark59 .anchor}**Figure 27:** Value Size
>
> There is a change of constant value from the ShelleyMA era,
> specifically:

-   adaOnlyUTxOSize = 29 instead of 27

-   k~0~ = 2 instead of 0

> Additionally, the new constants used in Alonzo have values :

-   JustDataHashSize = 10 words

-   NothingSize = 0 words

# Formal Properties

> This appendix collects the main formal properties that the new ledger
> rules are expected to satisfy. Note here that in every property in
> this section we consider a only phase-1 valid transactions, ie. ones
> that can indeed get processed.
>
> P1: *Consistency with Shelley.*

-   properties 15.6 - 15.16 (except 15.8 and 15.13) hold specifically in
    > the txValTag *tx* = True case, because the calculations refer to
    > the UTxO as if it was updated by a scripts- validating transaction

-   other properties hold as-is P2: *Consistency with Multi-Asset.*

-   properties 8.1 and 8.2 hold specifically in the txValTag *tx* = True
    > case, because the

> calculations refer to the UTxO as if it was updated by a
> scripts-validating transaction

-   other properties hold as-is

> **Definition C.1.** For a state *s* that is used in any subtransaction
> of CHAIN, we define Utxo(*s*) UTxO to be the UTxO contained in *s*, or
> an empty map if it does not exist. This is similar to the definition
> of Val in the Shelley specification.
>
> Similarly, we also define field*~v~* (*s*) for the field *v* that is
> part of the ledger state *s*, referenced by the typical variable name
> (eg. *fees* for the fee pot on the ledger).
>
> We also define a helper function *φ* as follows:
>
> *φ*(*x*, *tx*) := *x* txValTag *tx* = True
>
> 0 txValTag *tx* = False
>
> This function is useful to distinguish between the two cases where a
> transaction can mint tokens or not, depending on whether its scripts
> validate.
>
> **Property C.1** (General Accounting)**.** The *general accounting*
> property in Alonzo encompasses two parts

-   preservation of value property expressed via the produced and
    consumed calculations, applicable for transactions with txValTag
    *tx* = True, which is specified as in the ShelleyMA POV.

-   the preservation of value for txValTag *tx* = False, when only the
    collateral fees are collected into the fee pot.

> Both of these are expressed in the following lemma.
>
> **Lemma C.2.** For all environments *e*, transactions *tx* and states
> *s*, *s′*, if
>
> then
>
> *−*U*−*T*−*XO*→*S *s′*
>
> Val(*s*) + *φ*(mint (txbody *tx*), *tx*) = Val(*s^′^*)
>
> *Proof.* In the case that txValTag *tx* = True holds, the proof is
> identical to the proof of Lemma
>
> 9.1 of the multi-asset specification. Otherwise, the transition must
> have been done via the Scripts No rule, which removes collateral
> (txbody *tx*) from the UTxO, and increases the fee pot by the amount
> of the sum of Ada in the collateral UTxO entries. The value contained
> in *s* is not changed.
>
> Note that in the feesOK function, there is a check that verifies that,
> in the case that there are phase-2 scripts, there are no non-Ada
> tokens in the UTxOs which the collateral inputs reference, so non-Ada
> tokens do not get minted, burned, or transferred in this case.
>
> **Property C.2** (Extended UTxO Validation)**.** If a phase-1 valid
> transaction extends the UTxO, all its scripts validate (i.e. txValTag
> *tx* = True).

If a transaction is accepted and marked as paying collateral only (i.e.
txValTag *tx* = False),

then the only change to the ledger when processing the transaction is
that the collateral inputs

> are moved to the fee pot. In particular, it does not extend the UTxO.
>
> **Lemma C.3.** For all environments *e*, transactions *tx* and states
> *s*, *s′*, if and
>
> then
>
> *−*L*−*E*−*D*−*GE*→*R *s′*
>
> Also,
>
> Utxo(*s^′^*) ⊈ Utxo(*s*) *⇒* txValTag *tx* = True
>
> txvaltag *tx* = False *⇒*

-   field*~v~* (*s′*) = field*~v~* (*s*) for all *v ̸*= *f ees*, *v ̸*=
    > *utxo*

-   field *~f~ ~ees~* (*s^′^*) = field *fees* (*s*) + coin (Val
    > (collateral *tx \<l*/ Utxo(*s*)))

-   Utxo(*s^′^*) = collateral *tx \<l*/ Utxo(*s*)

> *Proof.* A ledger UTxO update is specified explicitly only by the
> UTXOS transition, and propa- gated (ie. applied as-specified) to a
> chain-state update via the UTXO and UTXOW transitions.
>
> The only case in which the UTXOS transition adds entries to the UTxO
> map is in the Scripts No rule, when txValTag *tx* = True. Adding
> entries to the UTxO map implies exactly that the updated map is not a
> submap of the original, so we get that
>
> Utxo(*s^′^*) ⊈ Utxo(*s*) *⇒* txValTag *tx* = True
>
> In the case that txValTag *tx* = False, LEDGER calls the rule that
> does not update DPState at all, only the UTxOState. This state update
> is specified in the UTXOS transition (and applied via the UTXO and
> UTXOW transitions).
>
> The only parts of the state that are updated are

-   the fee pot, which is increased by the amount of the sum of Ada in
    the collateral UTxO entries, and

-   the UTxO, where the collateral entries are removed.

> []{#_bookmark61 .anchor}**Property C.3** (Validating when No NN
> Scripts)**.** Whenever a valid transaction does not have any phase-2
> scripts, its txValTag = True.
>
> **Lemma C.4.** For all environments *e*, transactions *tx* and states
> *s*, *s′* such that
>
> *tx*
>
> *−*L*−*E*−*D*−*GE*→*R
>
> *s^′^*,
>
> If range(txscripts *tx*) *∩* Script^ph2^ = ∅ then txValTag = True.
>
> *Proof.* With the same argument as previously, we only need to discuss
> the equivalent claim for the UTXOS transition. Under these
> assumptions, *sLst* is an empty list. Thus evalScripts *sLst* = True,
> and the transition rule had to be Scripts*−*Yes.
>
> **Property C.4** (Paying fees)**.** In the case that all phase-2
> scripts in a transaction validate, the transaction pays at least the
> minimum transaction fee amount into the fee pot. In the case that some
> do not validate, it must pay at least the percentage of the minimum
> fee the collateral is required to cover.
>
> **Lemma C.5.** For all environments *e*, transactions *tx* and states
> *s*, *s′* such that
>
> The following holds :
>
> *−*L*−*E*−*D*−*GE*→*R *s′*

field (*s′*) field (*s*) + minfee *tx* txValTag = True .

quot (collateralPercent (field*~pp~* (*s*))) *∗* (minfee *tx*) 100
txValTag = False

> *Proof.* The fee pot is updated by the Scripts Yes and the Scripts No
> rules, one of which is necessarily called by a valid transaction via
> the sequence of transitions called in the order LEDGER, UTXOW, UTXO,
> UTXOS.
>
> The Scripts Yes rule (i.e. txValTag = True) transfers the amount of
> Lovelace in the txfee field of the transaction to the fee pot, which
> is checked to be at least the minfee by feesOK in the UTXO
>
> transition. So, we get
>
> field *~f~ ~ees~* (*s^′^*) = field *~f~ ~ees~* (*s*) + txfee *tx ≥*
> field *~f~ ~ees~* (*s*) + minfee *tx*
>
> The Scripts No rule (i.e. txValTag = False) removes the collateral
> inputs from the UTxO, and adds the balance of these realized inputs to
> the fee pot.
>
> field *~f~ ~ees~* (*s^′^*) = *f ield ~f~ ~ees~* (*s*) + ubalance
> (collateral *txb \<l utxo*)
>
> We can conclude that txrdmrs is non-empty whenever txValTag = False
> from the following observations :

-   txValTag = False whenever evalScripts fails.

-   evalScripts is a -fold over a list of scripts and their inputs,
    containing all scripts that need to be run to validate this
    transaction

-   All phase-1 scripts must succeed, as this is checked in phase-1
    validation (UTXOW rule check). Therefore, evalScripts encounters a
    failing script which is phase-2.

-   All phase-2 scripts necessarily have an associated redeemer attached
    to the transaction (UTXOW rule check)

> See Property [C.8](#_bookmark62) for more details on what inputs
> evalScripts has, and what we can say about the outcome of its
> computation with respect to its inputs.
>
> The feesOK check enforces that if a transaction has a non-empty
> txrdmrs field, the balance of the realized collateral inputs (which
> field *~f~ ~ees~* (*s*) is increased by as part of processing *tx*) is
>
> ubalance (collateral *txb \<l utxo*) *≥* quot (txfee *txb ∗*
> (collateralPercent *pp*)) 100 which, since txfee *txb ≥* minfee *txb*,
> gives
>
> *≥* quot (minfee *txb ∗* (collateralPercent *pp*)) 100))
>
> where txbody *tx* = *txb*. This shows that the total collateral that
> gets moved into the fee pot from the UTxO by the Scripts No rule is at
> least the minimum transaction fee scaled by the collateral percent
> parameter.
>
> field *~f~ ~ees~* (*s^′^*) *≥* field *~f~ ~ees~* (*s*) + quot (minfee
> *txb ∗* (collateralPercent *pp*)) 100))
>
> An immediate corollary to this property is that when the
> collateralPercent is set to 100 or more, the transaction always pays
> at least the minimum fee. This, in turn, implies that it pays at least
> the fee that it has stated in the txfee field.
>
> **Corollary C.6.** For all environments *e*, transactions *tx* and
> states *s*, *s′* such that
>
> *tx*
>
> *−*L*−*E*−*D*−*GE*→*R
>
> *s^′^ ∧* collateralPercent (field*~pp~* (*s*)) *≥* 100
>
> The following holds :
>
> field *~f~ ~ees~* (*s^′^*) *≥* field *~f~ ~ees~* (*s*) + minfee *tx*
>
> *Proof.* In both two cases in the lemma above, the field *~f~ ~ees~*
> field in the ledger state is increased by at least minfee *tx* :

-   when txValTag = True, the lemma states already that

> field *~f~ ~ees~* (*s^′^*) *≥* field *~f~ ~ees~* (*s*) + minfee *tx*

-   when txValTag = False, we have field *~f~ ~ees~* (*s′*) field *~f~
    > ~ees~* (*s*) + quot (minfee *txb*

> (collateralPercent *pp*)) 100
>
> field *~f~ ~ees~* (*s*) + quot (minfee *tx* 100) 100
>
> = field *~f~ ~ees~* (*s*) + minfee *tx*
>
> **Property C.5** (Correct tag)**.** The txValTag *tx* tag of a phase-1
> valid transaction must match the result of the evalScripts function
> for that transaction.
>
> **Lemma C.7.** For all environments *e*, transactions *tx* and states
> *s*, *s′* such that
>
> The following holds :
>
> *tx*
>
> *−*U*−*T*−*XO*→*S
>
> *s^′^*,
>
> where
>
> txValTag *tx* = evalScripts *tx sLst*
>
> *sLst* := collectTwoPhaseScriptInputs EI SysSt field*~pp~*(*s*) *tx*
> Utxo(*s*)
>
> *Proof.* Inspecting the Scripts Yes and the Scripts No rules of the
> UTXOS transition, we see that both the txValTag and the result of
> evalScripts are True in the former, and False in the latter.
>
> **Property C.6** (Replay protection)**.** A transaction always removes
> at least one UTxO entry from the ledger, which provides replay
> protection.
>
> **Lemma C.8.** For all environments *e*, transactions *tx* and states
> *s*, *s′* such that
>
> *tx*
>
> *−*L*−*E*−*D*−*GE*→*R
>
> *s^′^*,
>
> The following holds : Utxo (*s*) ⊈ Utxo (*s′*).
>
> *Proof.* The UTxO is updated by the Scripts Yes and the Scripts No
> rules, on of which is neces- sarily called by a valid transaction.
> Both of these rules remove UTxOs corresponding to a set of inputs.
>
> In both cases, there is a check that the removed inputs set is
> non-empty. The Scripts Yes rule of the UTXOS transition removes the
> UTxOs associated with the input set txinputs *tx* from the ledger. The
> txinputs *tx* set must be non-empty because there is a check in the
> UTXO rule (which calls UTXOS) that ensure this is true.
>
> For the Scripts No rule of the UTXOS transition removes the UTxOs
> associated with the input set collateral *tx* from the ledger. The
> collateral *tx* set must be non-empty because the feesOK function
> (called by the same rule that calls UTXO, UTXOS) ensures that in the
> case that the *tx* contains phase-2 scripts, collateral *tx* must be
> non-empty.
>
> Note that by property [C.3](#_bookmark61), phase-2 scripts must always
> be present if txValTag *tx* = False
>
> (that is, whenever Scripts*−*No rule is used).
>
> **Property C.7** (UTxO-changing transitions)**.** The UTXOS transition
> fully specifies the change in the ledger UTxO for each transaction.
>
> **Lemma C.9.** For all environments *e*, transitions TRNS,
> transactions *tx* and states *s*, *s′* such that
>
> The following holds :
>
> ***−***T*−*RN*→*S *s^′^*
>
> Utxo(*s*) *̸*= Utxo(*s^′^*) *⇒ e^′^ ⊢ u ^tx^ u^′^*
>
> where Utxo(*s*) = Utxo(*u*) *∧* Utxo(*s′*) = Utxo(*u′*) for some
> environment *e′*, and states *u*, *u′*.
>
> *Proof.* By inspecting each transition in this specification, as well
> as those inherited from the Shelley one, we see that a non-trivial
> update from the UTxO of *s* to that of *s′* must be done by
>
> UTXOS. Every other transition that changes the UTxO and has a signal
> of type Tx only applies the UTXOS.
>
> []{#_bookmark62 .anchor}**Property C.8** (Deterministic script
> evaluation)**.** The deterministic script evaluation property, also
> stated as "script interpreter arguments are fixed", is a property of
> the Alonzo ledger that guarantees that the outcome of phase-2 script
> validation in a (phase-1 valid) transaction depends only on the
> contents of that transaction, and not on when, by who, or in what
> block that transaction was submitted.
>
> For this property, we make some assumptions about things that are
> outside the scope of this specification :

-   The Plutus script interpreter is a pure function that receives only
    the arguments provided by the ledger when it is invoked by calling
    the runPLCScript function. We assume that this is also true in an
    implementation. In particular, the interpreter does not obtain any
    system randomness, etc.

-   We do not need to check here that the hashes that are the keys of
    the txscripts and txdats fields match the computed hashes of the
    scripts and datum objects they index. This is because these hashes
    must be computed as part of the deserialization of a transaction
    (see the CDDL specification), instead of being transmitted as part
    of the transaction and then checked. We assume these hashes are
    correct.

-   We assume that the consensus function epochInfoSlotToUTCTime for
    converting a slot interval into a system time interval is
    deterministic.

-   We assume that the two global constants, EpochInfo and SystemStart,
    > which it also takes as parameters, cannot change within the span
    > of any interval for which epochInfoSlotToUTCTime is able to
    > convert both endpoints to system time.

> The assumptions above are implicit in the functional style of
> definitions in this specification, but they are worth pointing out for
> implementation. With these assumptions in mind, we can say that script
> evaluation is deterministic.
>
> We split this result into a lemma and its corollary :

-   First, we demonstrate that all the scripts and their arguments that
    are collected for phase-2 validation are the same for two phase-1
    valid transactions with the same body, independent of the
    (necessarily valid) ledger state to which they are being applied

-   Second, we derive the corollary that under the same validity
    assumptions, phase-2 valida- tion results in the same outcome for
    both transactions

> []{#_bookmark63 .anchor}**Lemma C.10.** For all environments *e*,
> *e′*, transactions *tx*, *tx′* and states *s*, *s′*, *u*, *u′* such
> that *e* and *s* are subsets of fields of some valid chain state *c*,
> and *e′* and *s′* are subsets of fields of some valid chain state
> *c′*,
>
> *tx*
>
> *−*L*−*E*−*D*−*GE*→*R
>
> *tx′*
>
> *−*L*−*E*−*D*−*GE*→*R
>
> *u^′^*, txbody *tx* = txbody *tx^′^*
>
> The following holds :
>
> toSet (collectTwoPhaseScriptInputs EI SysSt field*~pp~*(*s*) *tx*
> Utxo(*s*))

=

> toSet (collectTwoPhaseScriptInputs EI SysSt field*~pp~*(*u*) *tx^′^*
> Utxo(*u*))
>
> *Proof.* The collectTwoPhaseScriptInputs function (see
> [7](#_bookmark22)) constructs a list where each entry contains a
> Plutus script and the arguments passed to the interpreter for its
> evaluation.
>
> To show that collectTwoPhaseScriptInputs returns a list containing the
> same elements for both *tx* and *tx′*, we observe that the set of
> elements from which this list is produced via toList is generated
> using the following functions, as well as set comprehension and list
> operations. We
>
> demonstrate that the functions used in this definition produce the
> same output for *tx* and *tx′*, as
>
> all the data they inspect is fixed by the transaction body :

-   scriptsNeeded : The PolicyID, Addr~rwd~, and DCert data output by
    > this function as the second term of the hash-purpose pair is
    > obtained directly from the mint, txwdrls, txcerts fields of the
    > transaction, which are all fixed by the body of the transaction.
    > These types of script purposes all include the hash of the
    > validating script.

> The only other data this function inspects is the UTxO entries
> associated with the txinputs
>
> (passed via the UTxO argument) to get the realized inputs. We know
> that the UTxO is a field in a valid chain state for both the phase-1
> valid transactions *tx* and the *tx′* (Utxo(*s*) and Utxo(*u*),
> respectively). This means that the TxId in each input present in
> either UTxO is a hash of the body of the transaction containing the
> TxOut part of the UTxO entry
>
> indexed by that input. The order of the outputs is also fixed by the
> body, which fixes the Ix
>
> of the entry.
>
> A different value in output part of the UTxO entry (or a different
> order of outputs) would necessarily imply that the hash of the body
> containing that output must be different. Therefore, for all Plutus
> script-locked realized inputs of either transaction, the script hash
> in the payment credential of the address (and, by the same argument,
> the datum hash) are
>
> fixed by the inputs in body of the transaction, despite not being
> explicitly contained in it.
>
> We then get that
>
> scriptsNeeded Utxo(*s*) (txbody *tx*) = scriptsNeeded Utxo(*u*)
> (txbody *tx^′^*)

-   getDatum : In the case the script purpose is of the input type, the
    > datum this function returns is one that is associated with the
    > corresponding realized input. More precisely, it is the datum
    > whose hash is specified in the realized input, and is looked up by
    > hash in the txdats transaction field. If there is no datum hash in
    > the realized input, or the script purpose is of a non-input type,
    > the empty list is returned.

> The UTXOW rule checks that the transaction is carrying all datums
> corresponding to its realized inputs. Since the inputs (and realized
> inputs) are the same for *tx* and *tx′* (fixed by
>
> the body), this guarantees that of the datum hashes in the realized
> inputs (and therefore, their preimages) are the same as well.

-   txscripts : in the UTXOW rule, there is a check that all the script
    preimages of the script hashes returned by the scriptsNeeded
    function must be present in this field.

-   indexedRdmrs : like scriptsNeeded, this function examines four
    fields fixed by the transaction body (mint, txwdrls, txcerts, and
    txinputs). It also looks at data in the txrdmrs field, which is
    fixed by the transaction body via the scriptIntegrityHash hash. This
    is done as follows: the UTXOW rule verifies that this
    hash-containing field matches the computed hash of the preimage
    constructed from several fields of the transaction, including
    txrdmrs (this calculation is done by the hashScriptIntegrity
    function).

-   language : this is directly conveyed by the type of a script.

-   costmdls : The hash calculated by the hashScriptIntegrity function
    > and compared to the hash value in the scriptIntegrityHash field
    > must include in the preimage the current cost models of all script
    > languages of scripts carried by the transaction. Recall that if a
    > cost model changed between when a transaction was submitted and
    > the time at which it was processed, the field and the calculated
    > hash values will not match.

-   valContext and txInfo : The valContext function is defined in
    > [A](#txinfo-construction) and is pure. All fields of the TxInfo
    > structure, with the exceptions listed below, are straightforward
    > translations of the corresponding transaction body fields (see
    > [A](#txinfo-construction)) that are given no additional arguments,
    > and

> therefore completely determined by *tx* and *tx′*. The fields not
> directly appearing in the
>
> body are :

-   txInfoInputs : this field contains the realized inputs of the
    > transaction which are fixed by the transaction and the unique UTxO
    > entries to which the inputs correspond. As explained above,
    > accessing information in realized inputs for script evaluation
    > does not break determinism.

-   txInfoValidRange : this field contains the transaction validity
    > interval as system time (converted from the slot numbers, which
    > are used to specify the interval in the transaction body). This
    > conversion is done by a function defined in the consensus layer,
    > and takes two global constants in addition to the slot interval
    > itself. Since the slot interval conversion function
    > epochInfoSlotToUTCTime necessarily succeeds

> if both *tx* and *tx′* pass phase-1 validation, the additional global
> constant arguments
>
> must be the same (by assumption). The determinism of this conversion
> is one of the assumptions of this property, and thus gives the same
> output for both transactions.

-   txInfoData : this field is populated with the datums (and their
    > hashes) in the transac- tion field txdats, which are fixed by the
    > body via the scriptIntegrityHash field.

-   txInfoId : this field contains the hash of the transaction body,
    > which is clearly the same for transactions with the same body.

> Therefore, each field of the TxInfo structure is the same for two
> transactions with the same body, ie.
>
> txInfo PlutusV1 Utxo(*s*) *tx* = txInfo PlutusV1 Utxo(*u*) *tx^′^*
>
> We can now make the general statement about evaluation of all scripts
> done in phase-2 validation : for any phase-1 valid transactions with
> the same body, the outcome of phase-2 script evaluation is the same.
> We make the same assumptions as in Lemma [C.10](#_bookmark63).
>
> **Corollary C.11.** For all environments *e*, *e′*, transactions *tx*,
> *tx′* and states *s*, *s′*, *u*, *u′* such that
>
> *tx*
>
> *−*L*−*E*−*D*−*GE*→*R
>
> *tx′*
>
> *−*L*−*E*−*D*−*GE*→*R
>
> *u^′^*, txbody *tx* = txbody *tx^′^*
>
> The following holds :
>
> evalScripts *tx* (collectTwoPhaseScriptInputs EI SysSt
> field*~pp~*(*s*) *tx* Utxo(*s*))

=

> evalScripts *tx^′^* (collectTwoPhaseScriptInputs EI SysSt
> field*~pp~*(*u*) *tx^′^* Utxo(*u*))
>
> *Proof.* Let us consider the use of arguments of evalScripts (see
> Figure [7](#_bookmark22)). The first argument (of type Tx) is only
> inspected in the case that the script *sc* (the first element in the
> pair at the head of the list of script-arguments pairs is a phase-1
> script. Since all phase-1 scripts are checked in phase one of
> validation (see [13](#_bookmark30)) by calling validateScript on all
> scripts attached to the transaction. For this to apply to *sc*, we
> must also show that *sc* is a script attached to the transaction (see
> the second argument explanation). Note also that the *tx* argument
> passed to evalScripts at the use site (in the UTXOS transition) is the
> same, unmodified *tx* as is the signal for the LEDGER transition. We
> verify this by inspecting the sequence of transitions through which it
> is propagated (UTXOS, UTXO, UTXOW, and LEDGER), and their signals.
>
> This allows us to conclude that at every step of the iteration over
> the script-arguments pairs list, the first argument to evalScripts,

-   has no impact on the outcome of script evaluation in the case the
    script being validated at this step is phase-2, as it is completely
    ignored, and,

-   because collectTwoPhaseScriptInputs filters out all phase-1 scripts,
    is, in fact, ignored al- ways.

> The second argument to evalScripts, ie. the list of scripts and their
> arguments, has already been shown to contain the same tuples for both
> transactions in the lemma above. The order of the list does not affect
> the validation outcome, since the interpreter is run on each tuple of
> a script and its arguments independently of all other tuples in the
> list. The function evalScripts is a
>
> -fold over the list. Thus, we may ignore the order of the elements in
> the generated list as it does not affect the evaluation outcome.
>
> From this we may conclude that the outcome of both phase-1 and phase-2
> script evaluations at each step of evalScripts must be the same for
> *tx* and *tx′*. Therefore, the -fold of them done by evalScripts also
> produces the same outcome for both transactions.

1.  *Commutativity of Translation.* Translate, then apply to Alonzo
    ledger is the same as apply to MA ledger, then translate the ledger.

2.  *Zero ExUnits.* If a script is run (there's a redeemer/exunits) , it
    will fail with 0 units

3.  *Cost Increase.* if a transaction is valid, it will remain valid if
    you increase the execution units

4.  *Cost Lower Bound.* if a transaction contains at least one valid
    script, it must have at least one execution unit

5.  *Tx backwards Compatibility.* Any transaction that was accepted in a
    previous version of the ledger rules has exactly the same cost and
    effect, except that the transaction output is extended.

6.  *Run all scripts.* All scripts attached to a transaction are run

7.  \...
